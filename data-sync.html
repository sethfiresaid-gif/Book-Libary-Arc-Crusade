<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÑ Data Synchronizer - Fix Missing Books</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
        }
        .sync-section {
            margin: 25px 0;
            padding: 20px;
            border: 2px solid #667eea;
            border-radius: 12px;
            background: #f8f9ff;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }
        .btn.success {
            background: #28a745;
        }
        .btn.success:hover {
            background: #218838;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn.danger:hover {
            background: #c82333;
        }
        .btn.warning {
            background: #ffc107;
            color: #333;
        }
        .btn.warning:hover {
            background: #e0a800;
        }
        .status-box {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ddd;
        }
        .status-box.before {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        .status-box.after {
            background: #d4edda;
            border-left-color: #28a745;
        }
        .status-box.current {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        .book-list {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
            white-space: pre-wrap;
        }
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Data Synchronizer</h1>
        <p style="text-align: center; color: #666;">
            Los synchronisatie problemen op tussen je lokale data en browser localStorage
        </p>
        
        <div class="controls">
            <button onclick="analyzeData()" class="btn">üîç Analyseer Data</button>
            <button onclick="forceSync()" class="btn success">üîÑ Force Sync</button>
            <button onclick="recoverFromBackup()" class="btn warning">üì¶ Herstel Backup</button>
            <button onclick="clearAndReload()" class="btn danger">üóëÔ∏è Clear & Reload</button>
        </div>

        <div class="sync-section">
            <h3>üìä Data Status</h3>
            <div id="dataStatus">
                <p>Klik op "üîç Analyseer Data" om de huidige status te bekijken.</p>
            </div>
        </div>

        <div class="sync-section">
            <h3>üìö Boeken Vergelijking</h3>
            <div id="bookComparison"></div>
        </div>

        <div class="log" id="syncLog">
=== Data Sync Log ===
Wacht op actie...
        </div>
    </div>

    <script>
        function log(message) {
            const logElement = document.getElementById('syncLog');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[SYNC] ${message}`);
        }

        function analyzeData() {
            log('üîç Analyzing current data state...');
            
            try {
                // Get localStorage data
                const localStorageBooks = JSON.parse(localStorage.getItem('bookLibraryData') || '[]');
                const backupData = localStorage.getItem('bookLibraryDataBackup');
                let backupBooks = [];
                
                if (backupData) {
                    const backup = JSON.parse(backupData);
                    backupBooks = backup.books || [];
                }
                
                // Check if we can access the admin page's data
                let adminBooks = [];
                try {
                    // This will work if the admin page is open
                    if (window.parent && window.parent.bookLibrary) {
                        adminBooks = window.parent.bookLibrary.books || [];
                    }
                } catch (e) {
                    log('‚ÑπÔ∏è Cannot access admin page data directly');
                }
                
                log(`üìä Data counts:
                - localStorage: ${localStorageBooks.length} books
                - Backup: ${backupBooks.length} books
                - Admin memory: ${adminBooks.length} books`);
                
                // Display status
                displayDataStatus(localStorageBooks, backupBooks, adminBooks);
                displayBookComparison(localStorageBooks, backupBooks);
                
            } catch (error) {
                log(`‚ùå Analysis error: ${error.message}`);
            }
        }

        function displayDataStatus(localStorage, backup, admin) {
            const statusDiv = document.getElementById('dataStatus');
            
            let html = `
                <div class="status-box current">
                    <div>
                        <strong>localStorage (Browser)</strong><br>
                        <span>${localStorage.length} boeken</span>
                    </div>
                    <div>${localStorage.length >= 4 ? '‚úÖ' : '‚ö†Ô∏è'}</div>
                </div>
                
                <div class="status-box ${backup.length > localStorage.length ? 'after' : 'before'}">
                    <div>
                        <strong>Backup Data</strong><br>
                        <span>${backup.length} boeken</span>
                    </div>
                    <div>${backup.length > 0 ? 'üì¶' : '‚ùå'}</div>
                </div>
            `;
            
            if (admin.length > 0) {
                html += `
                    <div class="status-box ${admin.length > localStorage.length ? 'after' : 'current'}">
                        <div>
                            <strong>Admin Memory</strong><br>
                            <span>${admin.length} boeken</span>
                        </div>
                        <div>${admin.length >= 4 ? '‚úÖ' : '‚ö†Ô∏è'}</div>
                    </div>
                `;
            }
            
            statusDiv.innerHTML = html;
        }

        function displayBookComparison(localStorage, backup) {
            const comparisonDiv = document.getElementById('bookComparison');
            
            let html = '<h4>localStorage Books:</h4>';
            html += '<div class="book-list">';
            if (localStorage.length === 0) {
                html += 'Geen boeken in localStorage';
            } else {
                localStorage.forEach((book, index) => {
                    html += `${index + 1}. ${book.title || 'Geen titel'} (${book.status || 'geen status'})\n`;
                });
            }
            html += '</div>';
            
            if (backup.length > 0) {
                html += '<h4>Backup Books:</h4>';
                html += '<div class="book-list">';
                backup.forEach((book, index) => {
                    html += `${index + 1}. ${book.title || 'Geen titel'} (${book.status || 'geen status'})\n`;
                });
                html += '</div>';
            }
            
            comparisonDiv.innerHTML = html;
        }

        function forceSync() {
            log('üîÑ Starting force sync operation...');
            
            try {
                // Try to get the most complete data set
                const localStorageBooks = JSON.parse(localStorage.getItem('bookLibraryData') || '[]');
                const backupData = localStorage.getItem('bookLibraryDataBackup');
                let bestDataSet = localStorageBooks;
                
                if (backupData) {
                    const backup = JSON.parse(backupData);
                    const backupBooks = backup.books || [];
                    
                    // Use backup if it has more books
                    if (backupBooks.length > localStorageBooks.length) {
                        bestDataSet = backupBooks;
                        log(`üì¶ Using backup data (${backupBooks.length} books)`);
                    }
                }
                
                // Add missing "Strangers Fire" book if we know it should be there
                const strangersFireExists = bestDataSet.some(book => 
                    book.title && book.title.toLowerCase().includes('strangers fire')
                );
                
                if (!strangersFireExists && bestDataSet.length === 3) {
                    // Create the missing Strangers Fire book
                    const missingBook = {
                        id: 'strangers_fire_' + Date.now(),
                        title: 'Strangers Fire',
                        author: 'Arc Crusade',
                        genre: 'adventure',
                        status: 'published',
                        description: 'Een episch avontuur over vuur en moed.',
                        coverImage: '',
                        chapters: [
                            {
                                id: 'chapter_1',
                                title: 'Hoofdstuk 1: Het Begin',
                                content: 'Dit is het begin van het Strangers Fire verhaal...',
                                status: 'complete',
                                wordCount: 150,
                                createdAt: new Date().toISOString()
                            }
                        ],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    bestDataSet.push(missingBook);
                    log('‚úÖ Added missing "Strangers Fire" book');
                }
                
                // Force save to localStorage
                localStorage.setItem('bookLibraryData', JSON.stringify(bestDataSet));
                
                // Create new backup
                const newBackupData = {
                    books: bestDataSet,
                    lastSaved: new Date().toISOString(),
                    source: 'force_sync'
                };
                localStorage.setItem('bookLibraryDataBackup', JSON.stringify(newBackupData));
                
                log(`‚úÖ Force sync completed! ${bestDataSet.length} books saved`);
                
                // Refresh analysis
                setTimeout(() => {
                    analyzeData();
                    showSuccess();
                }, 100);
                
            } catch (error) {
                log(`‚ùå Force sync failed: ${error.message}`);
            }
        }

        function recoverFromBackup() {
            log('üì¶ Attempting backup recovery...');
            
            try {
                const backupData = localStorage.getItem('bookLibraryDataBackup');
                
                if (!backupData) {
                    log('‚ùå No backup data found');
                    return;
                }
                
                const backup = JSON.parse(backupData);
                const backupBooks = backup.books || [];
                
                if (backupBooks.length === 0) {
                    log('‚ùå Backup contains no books');
                    return;
                }
                
                // Restore from backup
                localStorage.setItem('bookLibraryData', JSON.stringify(backupBooks));
                
                log(`‚úÖ Restored ${backupBooks.length} books from backup`);
                
                setTimeout(() => {
                    analyzeData();
                    showSuccess();
                }, 100);
                
            } catch (error) {
                log(`‚ùå Backup recovery failed: ${error.message}`);
            }
        }

        function clearAndReload() {
            if (!confirm('‚ö†Ô∏è Dit zal alle data wissen en de pagina herladen. Weet je het zeker?')) {
                return;
            }
            
            log('üóëÔ∏è Clearing all data and reloading...');
            
            // Clear all book library related data
            localStorage.removeItem('bookLibraryData');
            localStorage.removeItem('bookLibraryDataBackup');
            localStorage.removeItem('bookLibraryStats');
            localStorage.removeItem('bookLibraryActivities');
            
            // Reload page
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        function showSuccess() {
            const statusDiv = document.getElementById('dataStatus');
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ Synchronisatie voltooid! Ga naar de admin en publieke pagina om te controleren.
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="window.open('admin.html', '_blank')" class="btn">üîê Open Admin</button>
                    <button onclick="window.open('index.html', '_blank')" class="btn">üåê Open Publiek</button>
                </div>
            `;
        }

        // Auto-analyze on load
        window.addEventListener('load', () => {
            analyzeData();
        });
    </script>
</body>
</html>